<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Banana Ripening Detection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen flex flex-col items-center p-6 relative">

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <header class="text-center mb-6">
    <h1 class="text-4xl font-bold text-yellow-400">Banana Ripening Detection</h1>
    <p class="text-gray-400 mt-2">Real-time AI detection using Roboflow</p>
  </header>

  <main class="flex flex-col lg:flex-row gap-6 items-start w-full max-w-7xl">
    <!-- Webcam Feed -->
    <div class="relative w-[640px] h-[480px] border-4 border-yellow-400 rounded-lg overflow-hidden">
      <video id="video" autoplay playsinline class="absolute top-0 left-0 w-full h-full object-cover"></video>
      <canvas id="canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
    </div>

    <!-- Detection Panel -->
    <div class="w-full lg:w-[300px] space-y-6">
      <!-- Current Detections -->
      <section class="bg-gray-800 p-4 rounded-lg border border-yellow-400">
        <h2 class="text-xl font-semibold text-yellow-400 mb-2">ğŸ§  Current Detections</h2>
        <ul id="prediction-list" class="space-y-2 text-sm"></ul>
      </section>

      <!-- History Log -->
      <section class="bg-gray-800 p-4 rounded-lg border border-green-500 max-h-[250px] overflow-y-auto">
        <h2 class="text-xl font-semibold text-green-400 mb-2">ğŸ“œ Detection History</h2>
        <ul id="history-list" class="space-y-2 text-xs"></ul>
      </section>

      <!-- Buttons -->
      <div class="flex gap-3">
        <button id="download-btn"
          class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded shadow transition w-full">
          â¬‡ï¸ Download History
        </button>

        <button id="reset-btn"
          class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded shadow transition w-full">
          ğŸ—‘ï¸ Reset History
        </button>
      </div>
    </div>
  </main>

  <script>
    const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const predictionList = document.getElementById('prediction-list');
const historyList = document.getElementById('history-list');
const downloadBtn = document.getElementById('download-btn');
const resetBtn = document.getElementById('reset-btn');
const toastContainer = document.getElementById('toast-container');

// Start webcam
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    video.srcObject = stream;
  })
  .catch(err => {
    console.error("Webcam error:", err);
  });

// Perform detection every 5 seconds
setInterval(async () => {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
  const reader = new FileReader();

  reader.onloadend = () => {
    const base64Image = reader.result.replace(/^data:image\/jpeg;base64,/, '');

    fetch("https://serverless.roboflow.com/fruit-ripening-process/2?api_key=Ur7hXZ8pVPs9vpScKv7w", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: base64Image
    })
    .then(res => res.json())
    .then(data => {
      drawPredictions(data.predictions);
      updatePredictionList(data.predictions);
      updateHistory(data.predictions);
      speakDetections(data.predictions);
      showAlerts(data.predictions);
    })
    .catch(err => {
      console.error("Detection error:", err);
    });
  };

  reader.readAsDataURL(blob);
}, 5000);

// Draw bounding boxes
function drawPredictions(predictions) {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  predictions.forEach(pred => {
    const { x, y, width, height, class: label, confidence } = pred;

    ctx.strokeStyle = "#00FF00";
    ctx.lineWidth = 2;
    ctx.strokeRect(x - width / 2, y - height / 2, width, height);

    ctx.fillStyle = "#00FF00";
    ctx.font = "16px Arial";
    ctx.fillText(`${label} (${(confidence * 100).toFixed(1)}%)`, x - width / 2, y - height / 2 - 8);
  });
}

// Update summary
function updatePredictionList(predictions) {
  predictionList.innerHTML = '';
  predictions.forEach(pred => {
    const li = document.createElement('li');
    li.className = "bg-gray-700 px-3 py-1 rounded border-l-4 border-yellow-400";
    li.textContent = `${pred.class.toUpperCase()} - ${(pred.confidence * 100).toFixed(1)}%`;
    predictionList.appendChild(li);
  });
}

// Add to history
function updateHistory(predictions) {
  const timestamp = new Date().toLocaleTimeString();
  predictions.forEach(pred => {
    const li = document.createElement('li');
    li.className = "bg-gray-700 px-3 py-1 rounded border-l-4 border-green-500";
    li.textContent = `[${timestamp}] ${pred.class.toUpperCase()} - ${(pred.confidence * 100).toFixed(1)}%`;
    historyList.insertBefore(li, historyList.firstChild);
    if (historyList.children.length > 50) historyList.removeChild(historyList.lastChild);
  });
}

// Text-to-speech
function speakDetections(predictions) {
  predictions.forEach(pred => {
    const message = new SpeechSynthesisUtterance(
      `${pred.class} detected, ${(pred.confidence * 100).toFixed(0)} percent confidence`
    );
    message.lang = "en-US";
    speechSynthesis.speak(message);
  });
}

// Toast alert
function showAlerts(predictions) {
  predictions.forEach(pred => {
    const toast = document.createElement('div');
    toast.className = "bg-blue-700 text-white px-4 py-2 rounded shadow-lg animate-slide-in-right";
    toast.textContent = `ğŸ”” ${pred.class.toUpperCase()} detected - ${(pred.confidence * 100).toFixed(1)}%`;
    toastContainer.appendChild(toast);

    setTimeout(() => {
      toast.classList.add('opacity-0');
      setTimeout(() => toast.remove(), 500);
    }, 3500);
  });
}

// Download as .txt
downloadBtn.addEventListener('click', () => {
  const entries = Array.from(historyList.children);
  if (entries.length === 0) return alert("No detection history yet.");
  const text = entries.map(item => item.textContent).join('\n');
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `detection-history-${new Date().toISOString().slice(0, 10)}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// Reset history
resetBtn.addEventListener('click', () => {
  if (confirm("Clear all detection history?")) {
    predictionList.innerHTML = '';
    historyList.innerHTML = '';
  }
});

  </script>
</body>
</html>
