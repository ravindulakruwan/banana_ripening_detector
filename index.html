<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fresh Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slide-in-right {
      from { transform: translateX(100%); opacity: 0; }
      to   { transform: translateX(0);   opacity: 1; }
    }
    .animate-slide-in-right {
      animation: slide-in-right 0.4s ease-out;
      transition: opacity 0.4s ease-in;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen p-4 relative">

  <!-- Toast Notifications -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Header -->
  <header class="text-center mb-6">
    <h1 class="text-3xl md:text-4xl font-bold text-yellow-400">Banana Ripening Detection</h1>
    <p class="text-gray-400 mt-2 text-sm md:text-base">Real-time Banana Ripening Detector By TP53 Group</p>
  </header>

  <!-- Main Layout -->
  <main class="flex flex-col lg:flex-row gap-6 items-start max-w-7xl mx-auto">

    <!-- Video Section -->
    <div class="relative w-full max-w-[640px] aspect-video border-4 border-yellow-400 rounded-lg overflow-hidden">
      <video id="video" autoplay playsinline class="absolute w-full h-full object-cover"></video>
      <canvas id="canvas" class="absolute w-full h-full"></canvas>
    </div>

    <!-- Sidebar -->
    <div class="w-full lg:w-[320px] space-y-6">

      <!-- Controls -->
      <div class="flex flex-col sm:flex-row gap-3 justify-between">
        <button id="switch-camera-btn"
          class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-medium px-4 py-2 rounded shadow w-full">
          🔄 Switch Camera
        </button>
        <button id="toggle-flash-btn"
          class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium px-4 py-2 rounded shadow w-full hidden">
          🔦 Toggle Flashlight
        </button>
      </div>

      <!-- Predictions -->
      <section class="bg-gray-800 p-4 rounded-lg border border-yellow-400">
        <h2 class="text-xl font-semibold text-yellow-400 mb-2">🧠 Current Detections</h2>
        <ul id="prediction-list" class="space-y-2 text-sm"></ul>
      </section>

      <!-- History -->
      <section class="bg-gray-800 p-4 rounded-lg border border-green-500 max-h-[250px] overflow-y-auto">
        <h2 class="text-xl font-semibold text-green-400 mb-2">📜 Detection History</h2>
        <ul id="history-list" class="space-y-2 text-xs"></ul>
      </section>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row gap-3">
        <button id="download-btn"
          class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded shadow w-full">
          ⬇️ Download History
        </button>
        <button id="reset-btn"
          class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded shadow w-full">
          🗑️ Reset History
        </button>
      </div>
    </div>
  </main>

  <script>
    let currentCamera = 'environment'; // user or environment
let stream = null;
let track = null;
let torchOn = false;

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const predictionList = document.getElementById('prediction-list');
const historyList = document.getElementById('history-list');
const downloadBtn = document.getElementById('download-btn');
const resetBtn = document.getElementById('reset-btn');
const switchCameraBtn = document.getElementById('switch-camera-btn');
const toggleFlashBtn = document.getElementById('toggle-flash-btn');
const toastContainer = document.getElementById('toast-container');

// Start camera with facing mode
async function startCamera(facingMode = 'environment') {
  if (stream) stream.getTracks().forEach(t => t.stop());
  torchOn = false;
  toggleFlashBtn.classList.add('hidden');

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode, width: 640, height: 480 },
      audio: false
    });

    video.srcObject = stream;

    // Set track and check torch support
    track = stream.getVideoTracks()[0];
    const capabilities = track.getCapabilities();
    if (facingMode === 'environment' && capabilities.torch) {
      toggleFlashBtn.classList.remove('hidden');
    }
  } catch (err) {
    console.error('Camera error:', err);
    alert('Camera access failed.');
  }
}

// Toggle flashlight
async function toggleFlashlight() {
  if (!track) return;
  try {
    torchOn = !torchOn;
    await track.applyConstraints({
      advanced: [{ torch: torchOn }]
    });
  } catch (err) {
    console.warn("Torch not supported:", err);
    alert("Torch not supported on this device.");
  }
}

// Initial load
startCamera(currentCamera);

// Switch camera
switchCameraBtn.addEventListener('click', () => {
  currentCamera = currentCamera === 'user' ? 'environment' : 'user';
  startCamera(currentCamera);
});

// Flash toggle button
toggleFlashBtn.addEventListener('click', toggleFlashlight);

// Run detection every 5 seconds
setInterval(async () => {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
  const reader = new FileReader();

  reader.onloadend = () => {
    const base64Image = reader.result.replace(/^data:image\/jpeg;base64,/, '');
    fetch("https://serverless.roboflow.com/fruit-ripening-process/2?api_key=Ur7hXZ8pVPs9vpScKv7w", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: base64Image
    })
    .then(res => res.json())
    .then(data => {
      drawPredictions(data.predictions);
      updatePredictionList(data.predictions);
      updateHistory(data.predictions);
      speakDetections(data.predictions);
      showAlerts(data.predictions);
    })
    .catch(err => console.error("Detection error:", err));
  };

  reader.readAsDataURL(blob);
}, 5000);

// Draw boxes
function drawPredictions(predictions) {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  predictions.forEach(pred => {
    const { x, y, width, height, class: label, confidence } = pred;
    ctx.strokeStyle = "#00FF00";
    ctx.lineWidth = 2;
    ctx.strokeRect(x - width / 2, y - height / 2, width, height);
    ctx.fillStyle = "#00FF00";
    ctx.font = "16px Arial";
    ctx.fillText(`${label} (${(confidence * 100).toFixed(1)}%)`, x - width / 2, y - height / 2 - 8);
  });
}

// Live predictions
function updatePredictionList(predictions) {
  predictionList.innerHTML = '';
  predictions.forEach(pred => {
    const li = document.createElement('li');
    li.className = "bg-gray-700 px-3 py-1 rounded border-l-4 border-yellow-400";
    li.textContent = `${pred.class.toUpperCase()} - ${(pred.confidence * 100).toFixed(1)}%`;
    predictionList.appendChild(li);
  });
}

// History
function updateHistory(predictions) {
  const timestamp = new Date().toLocaleTimeString();
  predictions.forEach(pred => {
    const li = document.createElement('li');
    li.className = "bg-gray-700 px-3 py-1 rounded border-l-4 border-green-500";
    li.textContent = `[${timestamp}] ${pred.class.toUpperCase()} - ${(pred.confidence * 100).toFixed(1)}%`;
    historyList.insertBefore(li, historyList.firstChild);
    if (historyList.children.length > 50) {
      historyList.removeChild(historyList.lastChild);
    }
  });
}

// TTS
function speakDetections(predictions) {
  predictions.forEach(pred => {
    const msg = new SpeechSynthesisUtterance(
      `${pred.class} detected, ${(pred.confidence * 100).toFixed(0)} percent confidence`
    );
    msg.lang = "en-US";
    speechSynthesis.speak(msg);
  });
}

// Toast alerts
function showAlerts(predictions) {
  predictions.forEach(pred => {
    const toast = document.createElement('div');
    toast.className = "bg-blue-700 text-white px-4 py-2 rounded shadow-lg animate-slide-in-right";
    toast.textContent = `🔔 ${pred.class.toUpperCase()} - ${(pred.confidence * 100).toFixed(1)}%`;
    toastContainer.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('opacity-0');
      setTimeout(() => toast.remove(), 500);
    }, 3500);
  });
}

// Download
downloadBtn.addEventListener('click', () => {
  const entries = Array.from(historyList.children);
  if (!entries.length) return alert("No history to download.");
  const text = entries.map(item => item.textContent).join('\n');
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `detection-history-${new Date().toISOString().slice(0, 10)}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// Reset
resetBtn.addEventListener('click', () => {
  if (confirm("Clear detection history?")) {
    predictionList.innerHTML = '';
    historyList.innerHTML = '';
  }
});

  </script>
</body>
</html>
